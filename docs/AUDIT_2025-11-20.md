# Hermes Technical Audit — 2025-11-20

## Phase 1 – Critical Stability & Security

### Task 1: Secure Steam library downloads
- File: `cmd/steam/steam.go:55-95`
- Issue: `ImportSteamGames` currently calls `http://api.steampowered.com` via `http.Get` with no timeout. The Steam API key is transmitted over plain HTTP (line 58), and an unbounded default client can hang indefinitely, which is both a security and reliability risk.
- Actions:
  - Replace the hard-coded `http://` base URL with `https://` and inject an `http.Client` with explicit timeout/retry strategy (e.g., via parameter or package-level helper).
  - Avoid logging the full request URL (which contains the API key); instead, log only the host and steam ID.
  - Add unit tests that swap in an `httptest.Server` to assert HTTPS is used and that the client honors the timeout configuration.
- Definition of Done:
  - All Steam importer network calls use HTTPS with bounded timeouts and no longer risk leaking API keys through logs.
  - Tests cover success, timeout, and non-200 responses using dependency-injected clients.
  - Verify: Ensure all tests pass.

### Task 2: Honor Enhance overwrite semantics
- File: `cmd/enhance/cmd.go:200-218`
- Issue: `updateNoteWithTMDBData` always writes files with `overwrite=true` (line 215), ignoring the `overwrite` argument that should respect the `--overwrite-tmdb` flag. Users therefore cannot run dry/append modes safely.
- Actions:
  - Pass the `overwrite` boolean through to `fileutil.WriteFileWithOverwrite` and cover the differing behaviors with tests in `cmd/enhance/cmd_test.go`.
  - Add regression tests ensuring `EnhanceNotes` skips writes when overwrite is false and the file already contains TMDB data unless `--force` is provided.
  - Update log messages to reflect whether files were skipped or rewritten after the fix.
- Definition of Done:
  - Enhance obeys user-provided overwrite flags, with automated tests covering overwrite=false/true paths.
  - Existing behavior for forced overwrites remains unchanged aside from honoring the flag.
  - Verify: Ensure all tests pass.

### Task 3: Prevent IMDb imports from aborting after a single write failure
- File: `cmd/imdb/parser.go:328-345`
- Issue: `writeMoviesToMarkdown` returns immediately on the first `writeMovieToMarkdown` error (line 342), aborting the entire import even though subsequent entries could succeed. This contradicts the “continue on enrichment errors” behavior above it and can leave datasets half-processed without a summary of failures.
- Actions:
  - Collect write errors while continuing with the remaining movies; surface aggregated errors (count + sample) at the end rather than returning on the first failure.
  - Emit structured logs for skipped files so operators can triage, and ensure the CLI exit code reflects whether any write failures occurred.
  - Extend `cmd/imdb/parser_test.go` with a case that simulates a write failure (using a stubbed writer) and asserts that other movies are still processed and that errors are aggregated.
- Definition of Done:
  - IMDb imports continue processing after single-file write errors while still signaling overall failure when any write fails.
  - Tests cover both “some writes fail” and “all succeed” cases.
  - Verify: Ensure all tests pass.

## Phase 2 – Architecture & Performance

### Task 4: Decompose `cmd/root.go`
- File: `cmd/root.go:27-328`
- Issue: The 300+ line root command file mixes CLI schema definitions, config bootstrapping, logging setup, and importer execution. This violates separation of concerns, makes testing `Execute` difficult, and duplicates config logic scattered across the file.
- Actions:
  - Split the CLI struct declarations into a dedicated file (e.g., `cmd/cli_schema.go`), move config/logging bootstrap into `internal/cmdutil` helpers, and keep `Execute` focused on wiring Kong to command handlers.
  - Introduce small interfaces for importer entry points so `cmd/root.go` depends on abstractions (enabling mocks in `cmd/root_test.go`).
  - Update `cmd/root_test.go` (and add new tests) to assert that global flags flow into `config` and `viper` via the refactored helpers.
- Definition of Done:
  - `cmd/root.go` shrinks to orchestration glue, with schema/config/logging logic extracted into testable helpers.
  - Kong wiring and config updates are covered by automated tests to guard against regressions.
  - Verify: Ensure all tests pass.

### Task 5: Remove importer package globals
- Files: `cmd/goodreads/cmd.go:7-44`, `cmd/imdb/cmd.go:7-78`, `cmd/letterboxd/cmd.go:7-55`, `cmd/steam/cmd.go:7-47`
- Issue: Each importer stores mutable CLI state in package-level globals that `Parse{Importer}` implicitly reads. This prevents concurrent importer runs, complicates tests (global leakage between cases), and violates SOLID principles by hiding dependencies.
- Actions:
  - Introduce per-importer option structs (e.g., `type Runner struct { IO IODeps; Config CommandConfig }`) instantiated by Kong handlers, and update `Parse{Importer}` to accept these structs rather than reading globals.
  - Update tests to construct runners directly instead of mutating globals, ensuring no shared state remains after each test (verify with `t.Parallel()` runs).
  - Provide helper constructors in `internal/cmdutil` for deriving output/JSON paths so that logic is not duplicated across importers.
- Definition of Done:
  - No importer package exposes mutable global configuration; all inputs flow through explicit parameters or structs.
  - Existing CLI behavior remains intact, proven by updated `cmd/*/cmd_test.go`.
  - Verify: Ensure all tests pass.

### Task 6: Parallelize IMDb enrichment/output
- File: `cmd/imdb/parser.go:328-345`
- Issue: Markdown generation and enrichment runs strictly serially, even though OMDB/TMDB fetches and file writes are independent per movie. Large exports take hours and under-utilize available CPU/network.
- Actions:
  - Replace the simple `for` loop with a worker pool (configurable concurrency) that loads IDs, enriches, and writes per movie while respecting TMDB/OMDB rate-limit signals.
  - Protect shared TMDB cache/download directories with lightweight semaphores (e.g., limit disk writes) and ensure logs include movie titles for debugging out-of-order processing.
  - Add tests (using small fixture lists) to confirm ordering of success metrics and to ensure that aggregation of errors still functions with concurrent workers.
- Definition of Done:
  - IMDb imports leverage bounded concurrency, reducing total runtime on large CSVs without breaking ordering-sensitive side effects (logging, JSON export).
  - Concurrency is configurable via flag/env for tuning and is covered by deterministic tests.
  - Verify: Ensure all tests pass.

## Phase 3 – Quality & Documentation

### Task 7: Refactor Goodreads markdown writer and fix multiline fields
- File: `cmd/goodreads/markdown.go:16-183`
- Issue: `writeBookToMarkdown` is a 180-line monolith that mixes metadata derivation, cover downloads, and rendering. Additionally, lines 108-110 attempt to add multiline descriptions by prefixing `|\n`, but `fileutil.MarkdownBuilder.AddField` always quotes strings, so YAML ends up with the literal characters `|` rather than a block scalar.
- Actions:
  - Break `writeBookToMarkdown` into focused helpers (e.g., `buildFrontmatter`, `appendTags`, `attachCover`) and add unit tests for each concern.
  - Extend `MarkdownBuilder` with a dedicated `AddMultilineField` and use it for description/private notes; migrate existing block-like fields to the new helper.
  - Add snapshot-style tests in `cmd/goodreads/markdown_test.go` to ensure YAML emits proper block scalars and that refactoring preserves tag/output ordering.
- Definition of Done:
  - The Goodreads writer is composed of small, testable helpers, and multiline fields render as valid YAML block scalars.
  - Regression tests cover typical books plus edge cases (HTML reviews, missing covers).
  - Verify: Ensure all tests pass.

### Task 8: Harden OpenLibrary HTTP handling
- File: `cmd/goodreads/openlibrary.go:32-100`
- Issue: `fetchBookData` never checks `resp.StatusCode` before decoding JSON (lines 38-47), so rate limits or 5xx responses surface as JSON parse errors with no context. It also lacks retry/backoff logic even though later code throttles manually, leading to unhelpful errors and wasted calls.
- Actions:
  - Validate HTTP status before decoding; map 429/5xx codes to distinct errors so callers can decide whether to retry or degrade gracefully.
  - Add lightweight retry with exponential backoff (shared helper) and expose metrics/logging for cache vs. network hits.
  - Expand tests in `cmd/goodreads/openlibrary_test.go` to simulate non-200 responses and ensure retries + error messages behave as expected.
- Definition of Done:
  - OpenLibrary fetches fail fast with descriptive errors and only retry when beneficial, improving observability and reducing wasted work.
  - Tests cover successful fetches, 404s, and 429 scenarios using stub HTTP servers.
  - Verify: Ensure all tests pass.

### Task 9: Align configuration docs with real CLI behavior
- File: `docs/04_configuration.md:5-215`
- Issue: The documentation promises flags and env vars (`--config`, `--markdown-dir`, `HERMES_*`) that are not implemented in the Kong CLI (`cmd/root.go` only exposes overwrite/cache/datasette flags, and only `TMDB_API_KEY` is bound). This misleads users and support staff.
- Actions:
  - Update the configuration guide to describe the actual flags (`--overwrite`, `--datasette`, `--cache-db-file`, etc.) and remove fictional options until they exist.
  - Document the real environment variable bindings (currently only `TMDB_API_KEY`) and point to any planned additions as future work instead of definitive instructions.
  - Cross-link to `cmd/root.go` or auto-generated help output so the docs stay in sync; consider adding a CI check that fails if docs mention nonexistent flags.
- Definition of Done:
  - `docs/04_configuration.md` accurately reflects the current CLI and env support, with any roadmap items clearly labeled as future enhancements.
  - Documentation changes are reviewed alongside examples from `hermes --help` to ensure consistency.
  - Verify: Ensure all tests pass.
